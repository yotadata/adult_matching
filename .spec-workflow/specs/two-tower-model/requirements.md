# 要件定義書

## はじめに

この仕様書は、アダルトビデオマッチングアプリケーションの核心となるTwo-Tower推薦モデルの要件を定義します。Two-Towerアーキテクチャは、ユーザーとアイテム（ビデオ）を独立したタワーで処理し、高速で精度の高いパーソナライズ推薦を実現します。このモデルは現在の実装（評価ベース疑似ユーザーデータ）から進化し、リアルユーザーインタラクションに基づく推薦システムへの移行を可能にします。

## プロダクトビジョンとの整合性

このTwo-Towerモデルは、以下の方法でプロダクトビジョンを実現します：

- **AI駆動推薦**: 768次元ベクター埋め込みによる高精度な類似性マッチング
- **リアルタイム推薦**: 独立したタワー構造による500ms未満の推薦レスポンス
- **パーソナライゼーション**: ユーザー行動パターンの継続学習による個別最適化
- **スケーラビリティ**: 20万件以上のビデオと大量ユーザーに対応可能な効率的アーキテクチャ
- **モバイル最適化**: Edge Functions統合によるサーバーレス高速推薦配信
- **データドリブン**: A/Bテストと継続的モデル改善による推薦品質向上

## 要件

### 要件1: Two-Towerアーキテクチャの実装

**ユーザーストーリー**: ML エンジニアとして、ユーザーとアイテムを独立して処理するTwo-Towerアーキテクチャを実装し、高速で拡張性の高い推薦システムを構築したい。

#### 受入基準

1. システムがユーザータワーとアイテムタワーを独立して訓練・推論する際、各タワーが64次元の正規化されたベクター埋め込みを出力する必要がある（現状実装: 64次元で高性能達成済み）
2. ユーザータワーが受信する際、疑似ユーザー特徴（評価ベース行動パターン、ジャンル嗜好）から64次元ベクターを生成する必要がある
3. アイテムタワーが処理する際、ビデオ特徴（TF-IDFベクトル化タイトル、ジャンル・カテゴリエンコーディング、評価統計）から64次元ベクターを生成する必要がある
4. 両タワーの出力ベクターがL2正規化されてコサイン類似度で比較可能な形式である必要がある

### 要件2: 特徴エンジニアリングとデータ前処理

**ユーザーストーリー**: データサイエンティストとして、多様なデータソース（レビュー、メタデータ、ユーザー行動）を効率的に処理し、モデル訓練に最適化された特徴量を生成したい。

#### 受入基準

1. 疑似ユーザー特徴処理時、rating_based_pseudo_users.jsonから評価ベース行動パターン（like比率、評価分布、ジャンル嗜好）を抽出する必要がある（現状実装済み）
2. ビデオ特徴処理時、integrated_reviews.jsonのタイトル情報をTF-IDF ベクトル化、ジャンル・カテゴリをLabelEncoder処理、評価統計を標準化する必要がある（現状実装済み）
3. 訓練データ生成時、レビュー評価4以上→Like、3以下→Skipルールで生成された50疑似ユーザー・32,304アイテムデータを使用する必要がある（現状実装済み）
4. 特徴量処理時、TfidfVectorizer(max_features=1000)、StandardScaler、LabelEncoderで一貫した前処理を行う必要がある（現状実装済み）

### 要件3: 訓練データ生成と負例サンプリング

**ユーザーストーリー**: ML エンジニアとして、効果的な正例・負例ペアを生成し、モデルが意味のある推薦パターンを学習できる訓練データセットを構築したい。

#### 受入基準

1. 正例生成時、疑似ユーザーの評価4以上→Likeルールで変換されたユーザー-ビデオペアを使用する必要がある（現状実装済み）
2. 負例サンプリング時、各疑似ユーザーに対して未評価ビデオからランダムサンプリングで負例を生成する必要がある（現状実装済み）
3. 訓練データバランシング時、like_ratio=0.777の自然な分布を維持し、38,904総インタラクションでクラス不均衡を適切に処理する必要がある（現状実装済み）
4. データ分割時、validation_split=0.2で訓練・検証分割を行い、Early Stopping・ReduceLROnPlateauで過学習防止する必要がある（現状実装済み）

### 要件4: モデル訓練と最適化

**ユーザーストーリー**: ML エンジニアとして、高精度で安定したTwo-Towerモデルを訓練し、推薦品質を継続的に向上させたい。

#### 受入基準

1. 訓練プロセス実行時、Early StoppingとReduceLROnPlateauにより過学習を防止し、最適なモデル性能を実現する必要がある（現状実装済み）
2. 評価指標達成時、AUC-ROC > 0.95、AUC-PR > 0.99、Accuracy > 0.95の性能基準を満たす必要がある（**現状達成済み**: AUC-ROC=0.989, AUC-PR=0.997, Accuracy=0.952）
3. 埋め込み品質確保時、生成された64次元ユーザー・ビデオ埋め込みがL2正規化でコサイン類似度計算可能である必要がある（現状実装済み）
4. モデル保存時、user_tower.keras、item_tower.keras、full_model.keras形式で分離保存される必要がある（現状実装済み）

### 要件5: 本番環境デプロイメントと統合

**ユーザーストーリー**: システムエンジニアとして、訓練済みモデルを本番環境に安全にデプロイし、フロントエンドアプリケーションと統合したい。

#### 受入基準

1. モデルエクスポート時、TensorFlow SavedModel、ONNX、TensorFlow.js形式で多様な環境に対応する必要がある
2. Supabase統合時、Edge Functions経由で推薦APIを提供し、PostgreSQLの埋め込みテーブルと連携する必要がある
3. 埋め込み更新時、新規訓練後に全ユーザー・ビデオ埋め込みをバッチで効率的に更新する必要がある
4. API レスポンス時、推薦ビデオリストを類似度スコアと推薦理由とともに返却する必要がある

### 要件6: 継続学習とモデル改善

**ユーザーストーリー**: プロダクトマネージャーとして、ユーザー行動の変化に適応し、推薦品質を継続的に向上させる仕組みを構築したい。

#### 受入基準

1. インクリメンタル学習時、新規ユーザー行動データを定期的に取り込み、モデルを再訓練する必要がある
2. A/Bテスト対応時、複数のモデルバージョンを並行運用し、推薦品質を比較評価する必要がある
3. パフォーマンス監視時、推薦精度、エンゲージメント率、ユーザー満足度を継続的に追跡する必要がある
4. モデル更新時、新バージョンのモデルを段階的にロールアウトし、問題発生時の迅速なロールバックを可能にする必要がある

## 非機能要件

### パフォーマンス
- **推薦レスポンス時間**: 単一ユーザーへの推薦生成が500ms未満
- **バッチ推薦処理**: 1000ユーザーへの推薦が30秒未満で完了
- **モデル訓練時間**: 5万インタラクション規模のデータで1時間未満の訓練完了
- **埋め込み更新**: 20万ビデオ・1万ユーザーの埋め込み更新が10分未満

### スケーラビリティ
- **データ規模**: 20万ビデオ、10万ユーザー、100万インタラクションまで対応
- **同時推薦数**: 100同時ユーザーへの推薦配信
- **メモリ使用量**: 訓練時最大8GB、推論時最大2GB
- **ストレージ**: モデル・前処理器・埋め込みで総計1GB未満

### 精度・品質
- **推薦精度**: AUC-ROC > 0.95、AUC-PR > 0.99
- **コールドスタート**: 新規ユーザーでも意味のある推薦を提供
- **多様性**: 推薦結果の適切な多様性維持（ジャンル・メーカー分散）
- **説明可能性**: 推薦理由の明確な提示

### 運用・保守性
- **モデル管理**: バージョン管理とロールバック機能
- **監視**: 推薦品質とシステム性能の継続監視
- **デバッグ**: 推薦結果の分析・診断機能
- **ドキュメント**: 完全な技術文書と運用マニュアル

### セキュリティ・プライバシー
- **ユーザーデータ保護**: 埋め込みベクターからの個人情報復元防止
- **モデル保護**: 訓練済みモデルの不正アクセス防止
- **API セキュリティ**: 認証されたユーザーのみの推薦アクセス
- **プライバシー準拠**: GDPRその他プライバシー規制への適合