# 要件定義書

## はじめに

この仕様書は、アダルトビデオマッチングアプリケーションのデータベースアーキテクチャ要件を定義します。データベースは、ビデオメタデータ、ユーザー嗜好、AI駆動型推薦、リアルタイムインタラクションを処理するスケーラブルで安全かつ高性能なシステムをサポートする必要があります。このアーキテクチャは20万件以上のビデオ、ML推薦のためのベクター埋め込み、包括的なセキュリティポリシーによるデータプライバシーの確保に対応する必要があります。

## プロダクトビジョンとの整合性

このデータベースアーキテクチャは、以下の方法でプロダクトビジョンを直接サポートします：

- **スケーラブルアーキテクチャ**: ビジネス目標で概説された大規模ビデオデータベース（20万件以上）のサポート
- **AI駆動推薦**: パーソナライズされたコンテンツマッチングのためのTwo-Towerモデルベクター埋め込みの実現
- **プライバシーファースト**: データ保護原則のための行レベルセキュリティ（Row Level Security, RLS）ポリシーの実装
- **モバイル最適化**: リアルタイムスワイプインターフェースのための高速クエリレスポンス（50ms未満の遅延）
- **高品質コンテンツ**: API ソースからの包括的なビデオメタデータのための構造化スキーマ
- **データドリブン**: 適切なデータモデリングによるユーザー行動分析と推薦最適化のサポート

## 要件

### 要件1: コアデータモデル

**ユーザーストーリー**: プラットフォーム管理者として、ビデオコンテンツ、ユーザーインタラクション、ML推薦をサポートする包括的なデータモデルが欲しい。そうすることで、システムがパーソナライズされたビデオ発見体験を提供できる。

#### 受入基準

1. システムがビデオデータを保存する際、すべてのメタデータフィールド（タイトル、ジャンル、メーカー、価格、サムネイル、外部ID、ソース）を含む必要がある
2. ユーザーがコンテンツと相互作用する際、システムはタイムスタンプ付きでいいね/嫌いアクションを記録する必要がある  
3. MLモデルが学習データを必要とする際、システムは適切な形式でユーザー-ビデオインタラクションデータを提供する必要がある
4. ビデオコンテンツが更新される際、システムは関連するすべてのテーブル間で参照整合性を維持する必要がある

### 要件2: ベクター埋め込みサポート

**ユーザーストーリー**: ML エンジニアとして、データベースが効率的にベクター埋め込みを保存および検索できることを望む。そうすることで、高速な類似性ベースの推薦を実装できる。

#### 受入基準

1. ユーザー埋め込みを保存する際、システムは高次元ベクトル（128次元以上）をサポートする必要がある
2. 類似性検索を実行する際、システムは推薦クエリに対して500ms未満で結果を返す必要がある
3. 埋め込みを更新する際、システムは読み取りをブロックすることなく効率的にバッチ更新を処理する必要がある
4. 20万件以上のビデオにスケールする際、システムは適切なインデックスによってクエリパフォーマンスを維持する必要がある

### 要件3: ユーザーデータセキュリティとプライバシー

**ユーザーストーリー**: プラットフォームユーザーとして、個人データとインタラクション履歴が安全に保護されることを望む。そうすることで、プライバシーが維持され、データが他のユーザーからアクセスできない。

#### 受入基準

1. ユーザーがデータにアクセスする際、システムは行レベルセキュリティ（RLS）ポリシーを強制する必要がある
2. ユーザーインタラクションを保存する際、システムはuser_idによってデータを分離する必要がある
3. ユーザー認証時、システムはSupabase Authと安全に統合する必要がある
4. アダルトコンテンツデータを処理する際、システムはプライバシー規制と年齢確認要件に準拠する必要がある

### 要件4: パフォーマンスとスケーラビリティ

**ユーザーストーリー**: システムアーキテクトとして、データベースが大容量操作を効率的に処理することを望む。そうすることで、アプリケーションが高速な応答時間で多くの同時ユーザーにサービスを提供できるようにスケールできる。

#### 受入基準

1. 推薦クエリを提供する際、システムは500ms以内に応答する必要がある
2. 同時ユーザーを処理する際、システムは負荷下でもパフォーマンスを維持する必要がある
3. 大規模データセットを保存する際、システムは適切なインデックスによってストレージと取得を最適化する必要がある
4. ベクター類似性検索を実行する際、システムはpgvector拡張機能を効率的に使用する必要がある

### 要件5: データ整合性とリレーションシップ

**ユーザーストーリー**: データ管理者として、データベースがデータの整合性と適切なリレーションシップを維持することを望む。そうすることで、アプリケーションロジックがクリーンで正確なデータに依存できる。

#### 受入基準

1. リレーションシップを作成する際、システムは外部キー制約を強制する必要がある
2. ユーザーを削除する際、システムはカスケード削除を適切に処理する必要がある
3. ビデオメタデータを更新する際、システムはタグとパフォーマーのリレーションシップ間で整合性を維持する必要がある
4. APIデータをインポートする際、システムは一意制約を使用して重複エントリを防止する必要がある

### 要件6: マイグレーションとスキーマ進化

**ユーザーストーリー**: 開発者として、安全なスキーマ変更を可能にする堅牢なマイグレーションシステムが欲しい。そうすることで、データ損失やダウンタイムなしでデータベースが進化できる。

#### 受入基準

1. マイグレーションを作成する際、システムはバージョン管理付きでSupabaseマイグレーションツールを使用する必要がある
2. スキーマ変更を適用する際、システムは既存データを保持する必要がある
3. 変更をロールバックする際、システムは安全なロールバック機構を提供する必要がある
4. アップデートをデプロイする際、システムは適切なマイグレーション戦略によってダウンタイムを最小化する必要がある

## 非機能要件

### コードアーキテクチャとモジュラリティ
- **単一責任原則**: 各マイグレーションファイルは1つの特定のスキーマ変更を処理する
- **モジュラー設計**: データベース関数とトリガーは分離され、再利用可能である
- **依存関係管理**: マイグレーション依存関係は明確に定義され、順序付けされる
- **明確なインターフェース**: データベース型はフロントエンド使用のために適切にエクスポートおよび文書化される

### パフォーマンス
- **クエリレスポンス時間**: 推薦クエリ500ms未満、基本CRUD操作100ms未満
- **同時接続**: 100以上の同時データベース接続のサポート
- **ベクター検索パフォーマンス**: 適切なインデックスを持つpgvector拡張機能を使用した効率的な類似性検索
- **バッチ操作**: MLパイプラインデータの効率的な一括挿入/更新操作

### セキュリティ
- **行レベルセキュリティ（RLS）**: すべてのユーザー固有テーブルはRLSポリシーを実装する必要がある
- **認証統合**: Supabase Authシステムとのシームレスな統合
- **データ暗号化**: すべての機密データは保存時および転送時に暗号化される
- **アクセス制御**: 異なるユーザータイプのための適切な役割ベースのアクセス制御

### 信頼性
- **データ整合性**: すべてのトランザクションのACID準拠
- **バックアップと復旧**: ポイントインタイム復旧機能付きの自動バックアップ
- **エラーハンドリング**: 制約違反とデータ競合の適切な処理
- **監視**: データベースヘルス監視とアラート機能

### 使いやすさ
- **開発者体験**: 明確なスキーマ文書と型定義
- **マイグレーションツール**: 明確なフィードバック付きの使いやすいマイグレーションシステム
- **デバッグ**: データベース操作とクエリの包括的ログ
- **文書化**: 例と使用パターン付きの十分に文書化されたスキーマ