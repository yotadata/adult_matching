# AIレコメンド画面仕様 v1

本ドキュメントは、スワイプ画面と機能が重複しない「AIレコメンド」画面のコンセプト・UX・必要機能を整理したものです。スワイプ UI はリアルタイムな意思決定体験に特化しているため、AIレコメンド画面では「嗜好の可視化」「テーマ別の深掘り」「プレイリスト化」に主軸を置きます。

## 1. 目的と役割
- ユーザーの過去評価を踏まえ、AIが「なぜ」その作品を薦めるのかを説明しながらレコメンドする。
- 気分・利用シーンに合わせたテーマ（モード）を切り替え、短時間で視聴候補を確定させる。
- 作品をスワイプで一枚ずつ評価する前に、AIがまとめたセットを確認・編集し、ウォッチリストへ保存できるようにする。

> **差別化ポイント:** スワイプは「1枚ずつ評価するアクション」。AIレコメンド画面は「まとめて理解・比較し、視聴キューを組むアクション」に集中する。

## 2. 想定ユースケース
1. 今日はどんなジャンルを見ればいいか、AIの提案を俯瞰して決めたい。
2. 同じ嗜好を持つユーザーが今見ている作品を知りたい。
3. 出張・移動中など時間制限がある状況で、短時間で満足できる候補セットを生成したい。
4. パートナーと視聴するために、共有向けプレイリストを作成したい。

## 3. 成功指標（KPI）
- `ai_rec_playlist_add`：提案セットからウォッチリストへ追加された作品数。
- `ai_rec_mode_switch`：テーマ切替（モード変更）の利用率。
- `ai_rec_reason_expand`：レコメンド理由展開の閲覧回数。
- `ai_rec_share`：提案結果の共有アクション数。

## 4. 画面全体レイアウト
3カラム構成（デスクトップ） / 1カラム縦積み（モバイル）。

| カラム | コンテンツ | 目的 |
| ------ | ---------- | ---- |
| 左 | セッションサマリ & モード選択 | 今日の嗜好サマリとAIに与える意図の設定 |
| 中央 | AIが生成したセッション（最大3ブロック） | 候補作品の比較・選択 |
| 右 | ウォッチリスト下書き & シェア | 決めた作品を保存・共有 |

### 4.1 ヘッダー（全幅）
- タイトル: 「AIコンシェルジュ」
- サブコピー: 「今日の気分と最近の嗜好から、最短ルートで作品を見つけましょう。」
- アクション: `ガイドを見る`（チュートリアルモーダル）、`履歴に戻る`（過去の提案一覧へ遷移）

### 4.2 左カラム：インサイト & モード設定
1. **嗜好サマリカード**
   - 今週のトップタグ・出演者・視聴時間傾向を小さなチャートで表示。
   - データソース: `analysis-results` Edge Function。
2. **モードプリセット**
   - プルダウンではなくカード型ボタンで表示。例: `集中して楽しむ (Focus)`, `パートナーと`, `サクッと`, `新しい刺激`, `落ち着いて観る`。
   - 1つ選択で中央カラムの提案が更新される。
3. **カスタムモードビルダー**
   - トグル/スライダーで指定:
     - 視聴時間（ショート / ミディアム / ロング）
     - 気分（甘め / 情熱的 / 癒やし / ニッチ）
     - 視聴環境（ひとり / パートナー / 公開不可）
   - `AIに依頼`ボタンでモードを保存し、即時提案更新。最大3つまで保存可能。

### 4.3 中央カラム：AIセッション提案
各モードで最大3セクション（例: 「集中セット」「チャレンジ枠」「定番フォローアップ」）。

セクション構成:
- **ヘッダー:** セクション名 + 推薦理由のサマリ（例: `最近LIKEした#制服を強化するラインナップ`）
- **カードリスト:** 横スクロール可能なカード（5件程度）。カード内容は以下:
  - サムネイル
  - タイトル（2行まで）
  - タグバッジ 2つ
  - 推薦理由チップ（例: `視聴時間 25分 / 最近の似た作品`）
  - アクション: `詳細を見る`, `ウォッチリストに追加`, `除外`
- **セクションアクション:** `すべてウォッチリストに追加`, `シェアリンク生成`, `履歴比較`

#### 推薦理由の詳細
- カード右上の `i` アイコンでモーダルを開き、以下を表示:
  - 選定理由（タグ・出演者・視聴時間・類似ユーザー根拠）。
  - "あなたが最近LIKEした作品" と "似ている理由" の比較。
  - `似ていない理由`（除外された他候補があればサマリ）。

### 4.4 右カラム：ウォッチリスト下書き
1. **今セッションで選んだ作品**
   - ドラッグ&ドロップで並び替え可能。
   - 各行に `視聴予定時間` と `共有メモ` 入力欄。
2. **出力アクション**
   - `スワイプへ送る`: 選んだ作品をスワイプ待ち行列にセット。
   - `外部シェア`: URLコピー / LINE / X 共有ボタン。
   - `カレンダー連携`: 視聴日時をGoogle Calendarへエクスポート（将来オプション）。

## 5. 主要インタラクション
| シナリオ | 詳細 | 備考 |
| -------- | ---- | ---- |
| モード切替 | プリセットカードをクリックすると中央カラムのセッション3ブロックが再生成される。 | 再生成時にローディングスケルトン表示（500ms以上なら）。 |
| カスタムモード更新 | スライダー変更時はUI更新のみ、`AIに依頼`でAPI呼び出し。 | 呼び出し時にUser IntentをEdge Functionへ送る。 |
| 推薦理由展開 | 各カードの `i` アイコンクリックでモーダル。 | モーダルから直接 `除外` 可。 |
| ウォッチリスト追加 | `ウォッチリストに追加` ボタンで右カラムに追加。 | 追加済みならボタン状態を `済` 表示。 |
| スワイプへ送る | 右カラムの `スワイプへ送る` 実行で、フロント側ストアに選択作品IDを送信。 | スワイプ画面起動時にキャッチして初期カードとして表示する。 |

## 6. データフロー / 必要API
1. **AIレコメンド Edge Function 拡張**
   - 入力: `mode_id`, `custom_intent`, `limit_per_section`.
   - 出力: `sections: Array<{ id, title, rationale, items[] }>` 形式。
   - `items[].explainability`: 類似度スコア、根拠タグ、理由文章。
2. **嗜好サマリ API**
   - 既存 `analysis-results` を利用。レスポンスに `top_tags`, `top_performers`, `recent_like_durations` などを含める。
3. **ウォッチリスト保存 API**
   - 新規 `ai-recommend-playlist`（仮）。`items`, `notes`, `visibility` を受け取る。
4. **スワイプ連携**
   - `localStorage` or Supabase profile に `pending_swipe_queue` を保存し、スワイプ画面が初回マウント時に消費。

## 7. 非機能要件
- 既存のGlassmorphismテーマに準拠。
- `lg` 以上で3カラム、`md` 以下でコンテンツ順番を変更（中央→右→左）。
- レイテンシが1.5秒を超える場合は「AIが考え中」のアニメーション（Lottie想定）を表示。
- 推薦結果はユーザー操作なし状態で10分キャッシュし、再生成要求時に明示的なリロードトーストを表示。

## 8. アクセシビリティ & i18n
- モードカードはキーボード操作可能にする（`role="radio"` + `aria-checked`）。
- 推薦理由モーダルは `focus trap` を適用し、閉じた後は呼び出し元フォーカスへ戻す。
- 将来的な多言語対応に備え、説明テキストは翻訳辞書化を想定。

## 9. 開発タスク整理
### フロントエンド
- 新UIコンポーネント群（モードピッカー、セクションカード、ウォッチリストサイドバー）の実装。
- `useAiRecommend` フックの拡張（mode/customIntent パラメータ対応、セクション型レスポンス受け取り）。
- スワイプ画面とのデータ受け渡しストア整備。

### バックエンド（Edge Functions）
- `ai-recommend` の改修: Two-Towerスコアに加えて、タグクラスタリングと説明テキスト生成を行う。
- 新規 `ai-recommend-playlist` エンドポイントの作成（ウォッチリスト保存用）。

### 分析/計測
- `ai_rec_*` 系イベントの実装 (`frontend/src/lib/analytics.ts` 経由)。
- カスタムイベントのDebugView検証と BigQuery エクスポート設定。

## 10. 現行実装との差分と確認事項
- 現状の `frontend/src/app/ai-recommend/page.tsx` は単純なグリッド表示で、モード・説明・ウォッチリスト連携が存在しない。
- Edge Function `supabase/functions/ai-recommend/index.ts` はスタブ実装で、セクション構造や説明情報を返却していない。
- 本仕様を満たすには UI/Edge Function/Analytics の全面的な改修が必要。スワイプ画面とは用途が明確に分離されるため、機能重複は解消される。

---

更新日: 2025-11-06  
策定者: （記入者名を追記してください）
