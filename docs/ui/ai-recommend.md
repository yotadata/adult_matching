# AIレコメンド画面仕様 v1

本ドキュメントは、スワイプ画面と機能が重複しない「AIレコメンド」画面のコンセプト・UX・必要機能を整理したものです。スワイプ UI はリアルタイムな意思決定体験に特化しているため、AIレコメンド画面では「嗜好の可視化」「テーマ別の深掘り」「プレイリスト化」に主軸を置きます。

## 1. 目的と役割
- ユーザーの過去評価を踏まえ、AIが「なぜ」その作品を薦めるのかを説明しながらレコメンドする。
- 気分・利用シーンに合わせたテーマ（モード）を切り替え、短時間で視聴候補を確定させる。
- まとまった候補を俯瞰し、自分に合いそうなラインを一気に決めることで「次に何を観るか」を素早く判断できるようにする。

> **差別化ポイント:** スワイプは「1枚ずつ評価するアクション」。AIレコメンド画面は「まとめて理解・比較し、視聴キューを組むアクション」に集中する。

## 2. 想定ユースケース
1. 今日はどんなジャンルを見ればいいか、AIの提案を俯瞰して決めたい。
2. 同じ嗜好を持つユーザーが今見ている作品を知りたい。
3. 出張・移動中など時間制限がある状況で、短時間で満足できる候補セットを生成したい。
4. パートナーと視聴するために、共有向けプレイリストを作成したい。

## 3. 成功指標（KPI）
- `ai_rec_mode_switch`：テーマ切替（モード変更）の利用率。
- `ai_rec_reason_expand`：レコメンド理由展開の閲覧回数。
- `ai_rec_custom_apply`：カスタムモード適用率。

## 4. 画面全体レイアウト
2カラム構成（デスクトップ） / 1カラム縦積み（モバイル）。

| カラム | コンテンツ | 目的 |
| ------ | ---------- | ---- |
| 左 | 嗜好スナップショット & プリセット検索 | 最近の嗜好を見ながらタグ/出演者プリセットを選び、AIに伝える |
| 右 | AIが生成したセッション（最大3ブロック） | 候補作品の比較・選択 |

### 4.1 ヘッダー（全幅）
- タイトル: 「AIで探す」
- サブコピー: 「今日の気分と最近の嗜好から、最短ルートで作品を見つけましょう。」
- アクション: なし（初期表示でカードをすぐ閲覧できる構成）

### 4.2 左カラム：嗜好サマリ & プリセット入力
1. **嗜好サマリカード**
   - 直近90日のトップタグ/出演者をバッジ表示。
   - サマリから直接プリセットを追加できる（タップすると下部プリセットに反映）。
2. **プリセットピッカー（コンパクト）**
   - 「人気タグ」「人気出演者」「最近よく見たタグ」の3グループで最大9個のチップを提示。
   - チップはトグル動作（オン/オフ）で、選択中は目立つ色に。
3. **インライン入力**
   - アイコン付き 1 行入力。最大20文字でタグ/出演者名を部分一致サジェストし、Enter でチップ化。
   - 入力欄はセクション幅を圧迫しないサイズ（行高さ48px程度）。
4. **適用/クリア**
   - 適用: 選択済みタグ/出演者を API へ送信し、`prompt-match` セクションを更新。
   - クリア: 選択をリセットし、AI セレクト（自動提案）に戻す。

### 4.3 中央カラム：AIセッション提案
固定で最大3セクション（for-you / trend-now / prompt-match 兼 new arrivals）。

セクション構成:
- **ヘッダー:** セクション名 + 推薦理由サマリ（例: `人気タグ #制服 に近い作品`）
- **カードレール:** 横スクロール1行（12件）。カードは 16:9 / 220px 幅、タグと理由を簡潔に表示。
  - サムネイル
  - タイトル（2行まで）
  - タグバッジ 2つ
  - 推薦理由チップ（例: `#制服 / LIKEとの類似度 82%`）
  - アクション: `詳細を見る`, `作品ページへ`
- **セクションアクション:** `共有リンク生成`, `履歴比較`

#### 推薦理由の詳細
- カード右上の `i` アイコンでモーダルを開き、以下を表示:
  - 選定理由（タグ・出演者・視聴時間・類似ユーザー根拠）。
  - "あなたが最近LIKEした作品" と "似ている理由" の比較。
  - `似ていない理由`（除外された他候補があればサマリ）。

## 5. 主要インタラクション
| シナリオ | 詳細 | 備考 |
| -------- | ---- | ---- |
| プリセット選択 | チップのオン/オフで `selectedTag/Performer` を更新。適用クリックで API 呼び出し。 | 選択状態は localStorage に保持し、次回訪問時に提示。 |
| インライン入力 | 入力→Enterでチップ化（タグ/出演者IDに解決できたもののみ）。 | 解決できない場合は小さなエラーを表示。 |
| 推薦理由展開 | 各カードの `i` アイコンクリックでモーダル。 | モーダルでは説明テキストや類似指標を確認できる。 |
| セクション共有 | セクションヘッダーの共有ボタンからURLをコピー。 | 共有URL仕様は別途定義。 |

## 6. データフロー / 必要API
1. **AIレコメンド Edge Function 拡張**
   - 入力: `mode_id`, `custom_intent`, `limit_per_section`.
   - 出力: `sections: Array<{ id, title, rationale, items[] }>` 形式。
   - `items[].explainability`: 類似度スコア、根拠タグ、理由文章。
2. **嗜好サマリ API**
   - 既存 `insights` 画面で利用する `analysis-results` API を流用。レスポンスに `top_tags`, `top_performers`, `recent_like_durations` などを含める。

## 7. 非機能要件
- 既存のGlassmorphismテーマに準拠。
- `lg` 以上で左固定（320px）＋右可変2カラム、`md` 以下でコンテンツ順番を変更（中央→左）。
- レイテンシが1.5秒を超える場合は「AIが考え中」のアニメーション（Lottie想定）を表示。
- 推薦結果はユーザー操作なし状態で10分キャッシュし、再生成要求時に明示的なリロードトーストを表示（任意）。

## 8. アクセシビリティ & i18n
- チップは `role="switch"` もしくは `checkbox` としてキーボード操作可能にする。
- 推薦理由モーダルは `focus trap` を適用し、閉じた後は呼び出し元フォーカスへ戻す。
- 将来的な多言語対応に備え、説明テキストは翻訳辞書化を想定。

## 9. 開発タスク整理
### フロントエンド
- 新UIコンポーネント群（モードピッカー、セクションカード、推薦理由モーダル）の実装。
- `useAiRecommend` フックの拡張（mode/customIntent パラメータ対応、セクション型レスポンス受け取り）。
- セクション共有や説明展開に伴う計測イベントの実装。

### バックエンド（Edge Functions）
- `ai-recommend` の改修: Two-Towerスコアに加えて、タグクラスタリングと説明テキスト生成を行う。

### 分析/計測
- `ai_rec_*` 系イベントの実装 (`frontend/src/lib/analytics.ts` 経由)。
- カスタムイベントのDebugView検証と BigQuery エクスポート設定。

## 10. 現行実装との差分と確認事項
- 現状の `frontend/src/app/search/page.tsx` は単純なグリッド表示で、モード選択や説明付きセクション構成が存在しない。
- Edge Function `supabase/functions/ai-recommend/index.ts` はセクション構造・理由文生成を備える必要がある。
- コンシェルジュで多量の動画を提示し、スワイプは探索・評価に専念するという役割分担を維持する。

---

更新日: 2025-11-06  
策定者: （記入者名を追記してください）
