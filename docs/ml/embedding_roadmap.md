# 埋め込み拡張の方針メモ（AI検索向け）

現状:
- Two-Tower で `video_embeddings` / `user_embeddings` のみ保持。タグ/出演者の埋め込みは存在しない。
- AI検索（`ai-recommend`）ではタグ/出演者/キーワードをメタ情報でフィルタ・`ilike` 検索するのみで、埋め込み検索は未利用。

課題:
- タグ/出演者ベースのセマンティック検索をしたい場合、ベクトルがないため Two-Tower だけではカバーしづらい。
- キーワード→動画埋め込みへのマッピング（テキストエンコーダ）は現状用意していない。

検討オプション:
1) **既存動画埋め込みの間接利用**  
   - 選択タグ/出演者に紐づく動画の埋め込みを平均してクエリベクトル化し、`video_embeddings` を近傍検索する。  
   - 新テーブル不要、推論コストのみ増。  
   - 関連動画が少ないタグ/出演者はクエリ品質が不安定。

2) **タグ/出演者のテキスト埋め込みを追加**  
   - 名前をテキストエンコーダ（Sentence-BERT など）でベクトル化し、`tag_embeddings` / `performer_embeddings` を新設。  
   - タグ/出演者の平均ベクトルをクエリにして `video_embeddings` を検索、または動画側も同一テキストエンコーダで補助特徴を作る。  
   - モデル管理・データ同期のオーバーヘッドが増える。

3) **テキスト→動画埋め込みマッピングを用意**  
   - キーワードを埋め込みにして `video_embeddings` 空間に投影するテキストエンコーダを学習。  
   - 専用モデルが必要（Two-Tower のユーザー塔をテキスト入力対応に拡張する等）。

当面の方針（暫定案）:
- まずはオプション1（既存動画埋め込みの間接利用）で簡易にセマンティック検索を追加し、効果を確認する。  
- 効果が限定的な場合、タグ/出演者のテキスト埋め込みをオプション2で導入検討。  
- 本格的な検索体験が必要になったらオプション3のテキストエンコーダ追加を検討する。  

TODO:
- どの案を採用するか決定（ステークホルダー合意）。  
- 採用案に応じた実装計画（RPC/Edge Function/DBテーブル/バッチ作成）。  
- 評価指標とオフライン検証パスの整備。
