# AIで探す – 機能仕様（ドラフト）

## あるべき体験（大上段）
- まずは煩雑さの排除ではなく「できるだけ多くの作品と出会えること」を価値の中心に据える。初期表示の段階で新着・トレンド・人気など複数軸の候補を並列に提示し、眺めるだけで発見が進む状態を担保する。
- ユーザー入力は必要最低限に抑え、AI が LIKE 履歴や全体指標から自動でセットを提案する。任意入力（気分キーワード等）は追加の絞り込み手段であり、入力しなくても十分な推薦が得られることが前提。
- 探索軸は「自分向け」「全体トレンド」「新着」「AIキーワード」「通常検索」といった複数の見方をワンタップで切り替え可能にし、それぞれが異なる発見体験を生むようカード構成・メッセージを最適化する。
- サムネイル自体が訴求ポイントになる前提で、YouTube 的なタイル状レイアウトを基本とし、切り替え操作をしなくても多様な候補が視界に入るよう配置する（カルーセルだけに頼らず、1画面で複数セクションのサムネイルが確認できる構造を優先）。
- 新作や話題作を逃さないよう、更新日時・人気度・話題理由を可視化して「なぜ今見るべきか」が理解できる説明を添える。これにより多量の候補の中でも意思決定が早くなる。

## 目的
- ワンタップ前から大量の候補（新着・トレンド・個別最適など）を視界に入れ、「AIが提示する棚」を眺めるだけで好みに近づける。
- LIKE 履歴や人気指標を使い、自動で複数の視点（自分向け/流行/今の気分）を同時に提示し、必要最低限の入力で意思決定できる。
- AI 検索・通常検索・タグ/出演者フィルタを補助的に置き、能動的に探したい時も同じ画面からシームレスに遷移できる。

## ユースケース
1. ログイン済ユーザーが LIKE 履歴をもとに「自分向け」棚から作品を選ぶ。
2. 新着・トレンド・人気棚を回遊し、今押さえておきたい作品を一覧で把握する。
3. 「甘め」「刺激的」など少ない入力で気分に合わせた AI 推薦を得る。
4. さらに深掘りしたい場合にタグ/出演者/通常検索へ遷移し、同じ画面内で探索を継続する。

## 画面要件（`frontend/src/app/search/page.tsx`）
- **ヒーロー**：タイトルとサマリーのみ。操作ボタンは置かず、初期表示で多量のサムネイルに視線を集める。
- **プリセット入力（コンパクト）**：タグ/出演者をミニチップで提示し、タップで `選択済みタグ/出演者` が追加される。1行のインライン入力は「補助的に自由入力したい場合のみ」用意し、常に閉じた状態でカード欄を圧迫しない。適用時に `selectedTags/selectedPerformers` を API へ渡し、サムネイルセクションが即座に再描画される。
- **嗜好スナップショット**：直近90日の Topタグ/出演者（`useAnalysisResults`）をカード化。自分の好みを思い出すためのサマリ。
- **サムネイルレール**：各セクションは 1 行の横スクロールレールで 12 枚を並べる（カードは 16:9 / 220px 程度）。縦方向のスクロール量を抑え、サムネイルが主役になるレイアウトにする。
- **検索ショートカット**：通常検索・タグ絞り込み・出演者検索へのリンク/ボタンを同じページ下部に配置し、AI棚の閲覧から直ちに遷移できる。
- **状態表示**：ローディング骨組み（タイル版）、エラー（赤バナー）、候補ゼロ（空状態カード）を用意。

## バックエンド要件（`supabase/functions/ai-recommend`）
- リクエスト: `POST|GET { prompt?: string, limit_per_section?: number, tag_ids?: string[], performer_ids?: string[] }`
- **最低構成セクション**
  1. `for-you`: `get_videos_recommendations` （ユーザー埋め込み）から取得。
  2. `trend-now`: `get_popular_videos` （過去7日）。
  3. `fresh-releases`: `videos` テーブルから product_released_at / published_at を基準に新着順で取得。
  4. `prompt-match`: `tag_ids` と `performer_ids` を最優先フィルタに使い、足りない分を任意キーワードや for-you/trend 余剰で補完。未指定時は AI セレクトとして for-you/trend の残り候補から提案する。
- 追加で `fresh-picks`（最新リリース）や `hot-tags` などを順次拡張し、セクション数を増やしてもレスポンスを 1 API で返す。
- 各候補は `hydrateVideoDetails` で product_url / preview_url / duration を補完し、`pickUnique` で重複を避ける。
- レスポンス: `{ generated_at, sections[], metadata }`（候補件数、キーワード、ユーザー文脈、セクション上限を含む）。
- fallback: すべて空の際はトレンド+新着をミックスした「おすすめセット」を返し、UI 側では空状態にしない。

### プリセット入力のサーバ処理
- `tag_ids` / `performer_ids` は最大 5 件ずつ。`prompt-match` はまずこれら ID に一致する動画を `videos`, `video_tags`, `video_performers` から取得する。
- ID で足りない場合は `extractKeywords(prompt)` を使ってタイトル/タグ名/出演者名の部分一致で補完する。
- レスポンス `metadata` に `selected_tag_ids`, `selected_performer_ids` を含め、フロントで選択状態を復元できるようにする。

## 主要な挙動
- **プリセット選択**: チップのタップで `selectedTags/Performers` がトグルされ、適用ボタンを押すと `useAiRecommend` を再実行。次回アクセス時に直近の選択をサジェストする。
- **簡易入力**: インライン入力は 20 文字程度に制限し、自然文ではなくタグ候補へのショートカットとして扱う（実際はタグ/出演者IDに変換可能なもののみ送信）。
- **セクション描画**: `LayersIcon` でセクションIDに応じたアイコン/色を表示（for-you=緑、trend=青、prompt=ピンク）。
- **説明文**: Edge Function が `reason.summary/detail` を返し、カード内で表示する。

## 受け入れ観点
- 非ログイン時は API が 401 -> 画面にエラーを表示し、サイドバー/ヘッダーからも遷移できない（既存制御）。
- キーワードを変更すると 3 番目のセクションの `title`/`rationale` に入力語が反映される。
- セクションが 1 つでも候補を持つ限り、カードを横スクロールで閲覧できる。
- エラー/ローディング/空状態の表示が崩れない。

## 今後の拡張余地
- prompt キーワードをサジェストする自動案内。
- セクションごとの click イベントを `trackEvent` へ送信。
- `prompt-match` のマッチロジックをタグ/出演者だけでなく embedding 近傍検索へ拡張。

（最終確定前のドラフト。実装進行に合わせて更新すること）
