# 実装計画・タスク管理書

**プロジェクト**: アダルト動画マッチングアプリケーション  
**文書バージョン**: v1.0  
**作成日**: 2025年9月3日  
**最終更新**: 2025年9月3日

---

## 📋 目次

1. [実装フェーズ概要](#実装フェーズ概要)
2. [現在の状況](#現在の状況)
3. [フェーズ1: データ基盤構築](#フェーズ1-データ基盤構築)
4. [フェーズ2: ML パイプライン開発](#フェーズ2-ml-パイプライン開発)
5. [フェーズ3: 推薦システム実装](#フェーズ3-推薦システム実装)
6. [フェーズ4: 統合・最適化](#フェーズ4-統合最適化)
7. [リスク管理](#リスク管理)
8. [品質管理](#品質管理)

---

## 🎯 実装フェーズ概要

### マイルストーン・タイムライン

```
Week 1-2  │ Phase 1: データ基盤構築
Week 3-4  │ Phase 2: MLパイプライン開発  
Week 5-6  │ Phase 3: 推薦システム実装
Week 7-8  │ Phase 4: 統合・最適化
Week 9-12 │ テスト・デプロイ・運用開始
```

### 成功基準
- [ ] **データ品質**: 10万件以上の高品質レビューデータ収集
- [ ] **モデル精度**: AUC 0.70以上の推薦精度達成
- [ ] **システム性能**: API応答時間500ms以下
- [ ] **ユーザー体験**: いいね率60%以上

---

## 📊 現在の状況

### ✅ 完了済みタスク

| カテゴリ | タスク | 完了日 | 備考 |
|----------|-------|--------|------|
| **環境構築** | プロジェクト構造整理 | 2025-09-03 | data_processing/, ml_pipeline/ 分離 |
| **データ収集** | スクレイピングツール開発 | 2025-09-03 | cookie_dmm_scraper.py 完成 |
| **データ収集** | Cookie認証システム | 2025-09-03 | 年齢認証回避機能実装 |
| **データ処理** | 基本データクリーニング | 2025-09-03 | data_cleaner.py 実装 |
| **インフラ** | 基本Makefile作成 | 2025-09-03 | 簡単操作コマンド整備 |
| **設計書** | 要件定義書作成 | 2025-09-03 | requirements.md 完成 |
| **設計書** | 技術設計書作成 | 2025-09-03 | design.md 完成 |

### 📈 現在のデータ状況
- **収集済み**: 21件のDMMレビューデータ
- **前処理済み**: 3件の有効レビューデータ  
- **品質**: 基本クリーニング完了、特徴量抽出済み

### 🏗️ 現在のシステム状況
- **データベース**: Supabase PostgreSQL 稼働中
- **フロントエンド**: Next.js アプリケーション動作中
- **バックエンド**: Edge Functions 基本実装済み

---

## 📦 フェーズ1: データ基盤構築

**期間**: Week 1-2 (2025年9月4日 - 9月17日)  
**目標**: 安定的なデータ収集・処理基盤の確立

### 🎯 主要成果物
- [ ] 10万件以上のレビューデータ収集
- [ ] データベーススキーマ完全実装
- [ ] 自動データ処理パイプライン構築

### 📋 詳細タスク

#### T1.1: データ収集の拡張・安定化
```
優先度: 🔴 高
工数見積: 16時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T1.1.1** - 複数サイト対応スクレイパー開発 _(8h)_
  - FANZA API 連携機能追加
  - エラーハンドリング・リトライ機能強化
  - レート制限・アンチボット対策実装
- [ ] **T1.1.2** - 大規模データ収集の実行 _(6h)_
  - 10万件レビューデータ目標
  - プロキシローテーション実装
  - 収集ログ・モニタリング実装
- [ ] **T1.1.3** - データ品質チェック機能 _(2h)_
  - 重複除去アルゴリズム
  - データ完整性検証
  - 異常値検出・アラート

#### T1.2: データベーススキーマ実装
```
優先度: 🔴 高
工数見積: 12時間  
担当者: 開発者
```

**サブタスク:**
- [ ] **T1.2.1** - コアテーブル作成 _(4h)_
  - users, videos, performers, tags テーブル
  - インデックス・制約設定
  - RLS (Row Level Security) 設定
- [ ] **T1.2.2** - MLテーブル実装 _(4h)_
  - user_embeddings, video_embeddings
  - user_decisions, video_reviews
  - pgvector 拡張セットアップ
- [ ] **T1.2.3** - 初期データ投入 _(4h)_
  - 収集データのデータベース投入
  - データ整合性チェック
  - バックアップ・リストア手順確立

#### T1.3: データ処理パイプライン高度化
```
優先度: 🟡 中
工数見積: 10時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T1.3.1** - 感情分析機能実装 _(4h)_
  - 日本語感情分析モデル統合
  - レビューテキストの感情スコア化
  - 精度検証・チューニング
- [ ] **T1.3.2** - 高度特徴量抽出 _(4h)_
  - TF-IDF ベクトル化
  - カテゴリカル特徴量エンコーディング
  - 時系列特徴量生成
- [ ] **T1.3.3** - バッチ処理最適化 _(2h)_
  - 並列処理機能追加
  - メモリ効率化
  - 処理時間モニタリング

#### T1.4: レビューデータ→疑似ユーザー変換 🆕
```
優先度: 🔴 高
工数見積: 24時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T1.4.1** - 大規模データ収集システム _(8h)_
  - 10万件レビュー収集自動化
  - 複数サイト並行収集
  - 品質フィルタリング・重複除去
- [ ] **T1.4.2** - 疑似ユーザー生成パイプライン _(8h)_
  - レビュアーID抽出・匿名化
  - ユーザープロファイル生成
  - 嗜好特徴量抽出
- [ ] **T1.4.3** - 行動データ変換システム _(8h)_
  - 評価値→いいね/スキップ変換
  - 関連動画推定行動生成
  - 負例・時系列データ生成

#### T1.5: ML学習データ準備・検証 🆕
```
優先度: 🔴 高
工数見積: 16時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T1.5.1** - 特徴量エンジニアリング _(6h)_
  - ユーザー・アイテム特徴量設計
  - BERT埋め込みベクトル生成
  - カテゴリカル変数エンコーディング
- [ ] **T1.5.2** - データ品質検証システム _(6h)_
  - 疑似データ妥当性チェック
  - 分布バランス検証
  - 現実性スコア算出
- [ ] **T1.5.3** - 訓練用データセット作成 _(4h)_
  - train/validation/test分割
  - NPZ形式での高速保存
  - メタデータ・統計情報生成

### 🎯 フェーズ1 完了条件
- [ ] レビューデータ10万件以上収集完了
- [ ] **疑似ユーザー5000人以上生成完了** 🆕
- [ ] **ユーザー行動データ50万件以上生成完了** 🆕
- [ ] データベーススキーマ全テーブル稼働
- [ ] データ品質スコア90%以上達成
- [ ] **疑似データ品質スコア85%以上達成** 🆕
- [ ] **ML学習用データセット準備完了** 🆕
- [ ] 自動データ処理が24時間以内に完了

---

## 🤖 フェーズ2: ML パイプライン開発

**期間**: Week 3-4 (2025年9月18日 - 10月1日)  
**目標**: Two-Tower推薦モデルの開発・訓練

### 🎯 主要成果物
- [ ] BERT日本語埋め込みパイプライン
- [ ] Two-Tower推薦モデル実装
- [ ] モデル訓練・評価システム

### 📋 詳細タスク

#### T2.1: 埋め込みベクトル生成システム
```
優先度: 🔴 高
工数見積: 20時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T2.1.1** - BERT日本語モデル統合 _(8h)_
  - cl-tohoku/bert-base-japanese 導入
  - GPU対応・バッチ処理最適化
  - メモリ効率化・エラーハンドリング
- [ ] **T2.1.2** - テキスト前処理パイプライン _(6h)_
  - 日本語テキスト正規化
  - トークナイゼーション最適化
  - 長文テキストの分割処理
- [ ] **T2.1.3** - 埋め込みベクトル生成・保存 _(6h)_
  - レビューテキスト → 768次元ベクトル
  - バッチ処理による高速化
  - PostgreSQL pgvector 保存

#### T2.2: Two-Tower モデル実装（疑似ユーザー対応）
```
優先度: 🔴 高
工数見積: 30時間 (更新)
担当者: 開発者
```

**サブタスク:**
- [ ] **T2.2.1** - 疑似ユーザー対応モデルアーキテクチャ _(12h)_ 🆕
  - User Tower: 疑似ユーザー特徴量エンコーダー
  - Item Tower: 動画特徴量エンコーダー
  - Confidence Layer: 疑似データ信頼度重み付け
  - Interaction Layer: 類似度計算・予測
- [ ] **T2.2.2** - 特徴量エンジニアリング _(10h)_
  - 疑似ユーザー行動特徴量設計
  - レビューベース嗜好特徴量設計
  - 動画メタデータ特徴量設計
  - カテゴリカル変数エンコーディング
- [ ] **T2.2.3** - 信頼度重み付き学習システム _(8h)_ 🆕
  - 信頼度重み付き損失関数
  - データソース別重み調整
  - 段階的学習 (Staged Learning)
  - ネガティブサンプリング最適化

#### T2.3: 訓練・評価システム
```
優先度: 🟡 中  
工数見積: 16時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T2.3.1** - 訓練パイプライン実装 _(8h)_
  - データローダー・前処理
  - 早期終了・チェックポイント
  - TensorBoard ログ・可視化
- [ ] **T2.3.2** - 評価指標・テスト _(6h)_
  - AUC, Precision@K, Recall@K
  - 多様性指標 (Intra-list Diversity)
  - A/Bテスト準備
- [ ] **T2.3.3** - モデル最適化 _(2h)_
  - 軽量化 (quantization, pruning)
  - ONNX変換・推論高速化
  - Edge Functions デプロイ準備

### 🎯 フェーズ2 完了条件
- [ ] BERT埋め込み生成パイプライン稼働
- [ ] Two-Towerモデル訓練完了
- [ ] 検証データでAUC 0.70以上達成
- [ ] 推論時間100ms以下達成

---

## 🎛️ フェーズ3: 推薦システム実装

**期間**: Week 5-6 (2025年10月2日 - 10月15日)  
**目標**: リアルタイム推薦API・フロントエンド統合

### 🎯 主要成果物
- [ ] 高性能推薦API実装
- [ ] リアルタイム埋め込み更新
- [ ] フロントエンド完全統合

### 📋 詳細タスク

#### T3.1: 推薦API実装
```
優先度: 🔴 高
工数見積: 18時間
担当者: 開発者  
```

**サブタスク:**
- [ ] **T3.1.1** - Edge Function 推薦API _(8h)_
  - /api/recommendations エンドポイント
  - Two-Towerモデル推論処理
  - 候補生成・フィルタリング
- [ ] **T3.1.2** - 多様性・再ランキング _(6h)_
  - ジャンル多様性確保アルゴリズム
  - 人気度バイアス調整
  - 新規動画ブースト機能
- [ ] **T3.1.3** - キャッシング・高速化 _(4h)_
  - ユーザー埋め込みキャッシュ
  - 推薦結果キャッシュ
  - Redis/Memcached 統合

#### T3.2: ユーザー行動処理システム
```
優先度: 🔴 高
工数見積: 14時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T3.2.1** - 行動データ収集API _(6h)_
  - /api/user-actions エンドポイント  
  - リアルタイム行動ログ保存
  - セッション管理・整合性チェック
- [ ] **T3.2.2** - リアルタイム埋め込み更新 _(6h)_
  - ユーザー行動 → 埋め込み更新
  - 増分学習アルゴリズム
  - 更新トリガー・バッチ処理
- [ ] **T3.2.3** - 行動分析・ダッシュボード _(2h)_
  - ユーザー行動統計
  - 推薦精度モニタリング
  - A/Bテスト結果可視化

#### T3.3: フロントエンド統合・UX改善
```
優先度: 🟡 中
工数見積: 12時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T3.3.1** - スワイプUI・推薦連携 _(6h)_
  - リアルタイム推薦データフェッチ
  - スワイプ操作 → 行動データ送信
  - 無限スクロール・プリロード
- [ ] **T3.3.2** - パフォーマンス最適化 _(4h)_
  - 画像遅延読み込み
  - API呼び出し最適化
  - レスポンシブデザイン改善
- [ ] **T3.3.3** - 初回ユーザー体験 _(2h)_
  - オンボーディングフロー
  - 好み設定UI
  - チュートリアル・ガイド

### 🎯 フェーズ3 完了条件
- [ ] 推薦API応答時間500ms以下達成
- [ ] リアルタイム埋め込み更新機能稼働
- [ ] フロントエンド完全統合・動作確認
- [ ] ユーザーテストでいいね率60%以上

---

## 🔧 フェーズ4: 統合・最適化

**期間**: Week 7-8 (2025年10月16日 - 10月29日)  
**目標**: システム統合・性能最適化・運用準備

### 🎯 主要成果物
- [ ] 完全統合システム
- [ ] 性能最適化・モニタリング
- [ ] 運用マニュアル・文書

### 📋 詳細タスク

#### T4.1: システム統合・テスト
```
優先度: 🔴 高
工数見積: 16時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T4.1.1** - エンドツーエンドテスト _(8h)_
  - ユーザー登録 → 推薦 → 行動のフルフロー
  - 負荷テスト・ストレステスト
  - エラーハンドリング・復旧テスト
- [ ] **T4.1.2** - データ整合性テスト _(4h)_
  - データベース整合性チェック
  - 埋め込みベクトル品質検証
  - バックアップ・リストア確認
- [ ] **T4.1.3** - セキュリティテスト _(4h)_
  - 年齢認証システムテスト
  - SQLインジェクション・XSS対策
  - プライバシー保護機能確認

#### T4.2: 性能最適化・スケーラビリティ
```
優先度: 🔴 高
工数見積: 14時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T4.2.1** - データベース最適化 _(6h)_
  - インデックス最適化
  - クエリ性能チューニング
  - 接続プール・トランザクション最適化
- [ ] **T4.2.2** - API性能最適化 _(6h)_
  - Edge Function 最適化
  - 並列処理・非同期処理改善
  - レスポンス圧縮・キャッシング
- [ ] **T4.2.3** - フロントエンド最適化 _(2h)_
  - バンドルサイズ削減
  - 画像最適化・CDN設定
  - Core Web Vitals 改善

#### T4.3: 運用・モニタリング・文書化
```
優先度: 🟡 中
工数見積: 12時間
担当者: 開発者
```

**サブタスク:**
- [ ] **T4.3.1** - モニタリング・アラート _(6h)_
  - システムヘルスダッシュボード
  - 異常検知・自動アラート
  - ログ集約・分析システム
- [ ] **T4.3.2** - 運用マニュアル作成 _(4h)_
  - デプロイ手順・トラブルシューティング
  - データバックアップ・復旧手順
  - モデル再訓練・更新手順
- [ ] **T4.3.3** - API文書・開発者ガイド _(2h)_
  - OpenAPI仕様書作成
  - SDK・サンプルコード提供
  - 開発者向けドキュメント整備

### 🎯 フェーズ4 完了条件
- [ ] 全システム統合・テスト完了
- [ ] 性能要件（応答時間・スループット）達成
- [ ] 運用マニュアル・モニタリング完備
- [ ] 本番環境デプロイ準備完了

---

## ⚠️ リスク管理

### 高リスク項目

#### R1: データ収集の安定性
```
リスク内容: スクレイピング対象サイトの仕様変更・アクセス制限
影響度: 🔴 高
発生確率: 🟡 中

対策:
- 複数データソース確保（DMM + FANZA + その他）
- API利用への移行検討
- プロキシローテーション・UA変更
- 定期的な収集システム確認

緊急時対応:
- 既存データでの開発継続
- サンプルデータ生成機能
- 手動データ収集の実施
```

#### R2: モデル精度の未達
```
リスク内容: Two-Towerモデルが目標精度(AUC 0.70)に届かない
影響度: 🟡 中
発生確率: 🟡 中

対策:
- 複数モデルアーキテクチャの並行検討
- ハイパーパラメータ自動調整
- 外部事前学習モデル活用
- データ品質向上・特徴量エンジニアリング強化

代替案:
- 協調フィルタリング併用
- ルールベース推薦との混合
- より単純なモデルでのMVP
```

#### R3: システム性能の問題
```
リスク内容: API応答時間・スループット要件の未達
影響度: 🟡 中
発生確率: 🟡 中

対策:
- 早期性能テスト実施
- キャッシング戦略の徹底
- Edge Functions最適化
- データベースクエリチューニング

緊急時対応:
- 推薦結果の事前計算・保存
- 簡略化されたモデルでの運用
- CDN・キャッシングの強化
```

### 中リスク項目

#### R4: 開発スケジュール遅延
```
対策:
- 週次進捗レビュー・調整
- MVP機能への絞り込み
- 外部ライブラリ・サービス活用
- 並行開発の推進
```

#### R5: データプライバシー・法的問題
```
対策:
- 完全匿名化システム実装
- 利用規約・プライバシーポリシー整備
- 法的レビューの実施
- データ保持期間の明確化
```

---

## 🔍 品質管理

### テスト戦略

#### 単体テスト
```python
# 各モジュールのテスト
ml_pipeline/tests/
├── test_data_cleaner.py      # データクリーニング
├── test_embeddings.py        # 埋め込み生成
├── test_two_tower.py         # モデル推論
└── test_recommendations.py   # 推薦ロジック
```

#### 統合テスト
```typescript
// API・システム統合テスト
tests/integration/
├── test_recommendation_api.ts   # 推薦API
├── test_user_actions.ts         # ユーザー行動
├── test_data_pipeline.ts        # データパイプライン
└── test_ml_pipeline.ts          # MLパイプライン
```

#### 性能テスト
```bash
# 負荷テスト・ストレステスト
artillery run tests/performance/recommendation-load.yml
k6 run tests/performance/api-stress.js
```

### 品質基準

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| **コードカバレッジ** | 80%以上 | Jest/pytest coverage |
| **API応答時間** | 95% < 500ms | LoadTesting結果 |
| **推薦精度** | AUC > 0.70 | 検証データでの評価 |
| **データ品質** | 欠損率 < 5% | データ品質チェック |
| **可用性** | 99.5%以上 | アップタイムモニタリング |

### コードレビュー・承認フロー

```
1. Feature branch作成・実装
2. 自動テスト実行・パス確認  
3. コードレビュー実施
4. QA環境でのテスト
5. Main branch マージ・デプロイ
```

---

## 📈 進捗管理・報告

### 週次進捗レビュー
**毎週金曜日 17:00**

**議題:**
- [ ] 完了タスクの確認
- [ ] 進捗遅延・ブロッカーの特定
- [ ] 次週計画の調整
- [ ] リスク・課題の評価

### 月次マイルストーン確認
**各フェーズ完了時**

**評価項目:**
- [ ] 成果物の品質・完成度
- [ ] 性能・精度指標の達成状況
- [ ] 予算・スケジュールの遵守
- [ ] リスクの顕在化・対応状況

### 課題管理

| 課題ID | 内容 | 優先度 | 状態 | 担当者 | 期限 |
|--------|------|--------|------|--------|------|
| I-001 | データ収集の大規模化 | 🔴 | Open | 開発者 | Week2 |
| I-002 | BERT推論の高速化 | 🟡 | Open | 開発者 | Week4 |
| I-003 | UI/UXの改善 | 🟢 | Open | 開発者 | Week6 |

---

## 🎉 プロジェクト完了定義

### 最終成果物チェックリスト

#### 📊 データ・ML
- [ ] 10万件以上のレビューデータ収集・処理完了
- [ ] Two-Tower推薦モデル AUC 0.70以上達成
- [ ] リアルタイム推薦API 500ms以下応答
- [ ] 自動データ処理パイプライン稼働

#### 🎛️ システム・インフラ
- [ ] 本番環境構築・デプロイ完了
- [ ] モニタリング・アラート設定完了
- [ ] バックアップ・災害対策準備完了
- [ ] セキュリティ・プライバシー対策実装

#### 📋 文書・運用
- [ ] API仕様書・開発者ドキュメント完備
- [ ] 運用マニュアル・トラブルシューティング完備
- [ ] ユーザーマニュアル・ヘルプ完備
- [ ] 法的文書（利用規約・プライバシーポリシー）準備

#### 🧪 テスト・品質
- [ ] 全テストスイート実行・パス
- [ ] 性能・負荷テスト基準クリア
- [ ] セキュリティ監査・脆弱性対応完了
- [ ] ユーザビリティテスト実施・改善反映

**最終承認**: 全チェック項目完了後、プロジェクト完了とみなす

---

**文書管理**  
**作成者**: Claude Code  
**承認者**: -  
**次回レビュー予定**: 毎週金曜日