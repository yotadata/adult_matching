name: "[CiCd] Sub - Deploy DB Migrations"

on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Apply migrations to remote (type "yes" to confirm)'
        required: true
        default: 'no'
      target:
        description: 'Target project ref (defaults to SUPABASE_PROJECT_ID secret)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        working-directory: supabase
        run: |
          PROJECT_REF=${{ inputs.target != '' && inputs.target || env.SUPABASE_PROJECT_ID }}
          echo "Linking to project: $PROJECT_REF"
          supabase link --project-ref "$PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"

      - name: Push migrations (push to main)
        if: github.event_name == 'push'
        working-directory: supabase
        run: supabase db push --include-all

      - name: Confirm apply flag (dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.apply }}" != "yes" ]; then
            echo "Refusing to apply migrations without confirmation (set input 'apply' to 'yes')." >&2
            exit 1
          fi

      - name: Push migrations (dispatch)
        if: github.event_name == 'workflow_dispatch'
        working-directory: supabase
        run: |
          PROJECT_REF=${{ inputs.target != '' && inputs.target || env.SUPABASE_PROJECT_ID }}
          echo "Applying migrations to: $PROJECT_REF"
          supabase db push --include-all

      - name: Notify Discord (DB Deploy)
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            STATUS="✅ success"
            if [ "$JOB_STATUS" != "success" ]; then
              STATUS="❌ $JOB_STATUS"
            fi
            curl -X POST -H "Content-Type: application/json" -d "{\"content\":\"[CiCd Deploy DB] $STATUS\"}" "$DISCORD_WEBHOOK_URL"
          fi

    # Notes:
    # - Configure repo secrets: SUPABASE_ACCESS_TOKEN, SUPABASE_PROJECT_ID, SUPABASE_DB_PASSWORD
    # - Uses 'supabase db push' to apply migrations in supabase/migrations to the linked project.
