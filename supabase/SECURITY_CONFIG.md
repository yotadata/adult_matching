# Supabaseセキュリティ設定ガイド

## 概要

このドキュメントは、adult_matchingプロジェクトのSupabaseセキュリティ設定について説明します。

## セキュリティ強化設定

### 1. API制限の強化

#### データ取得制限
- **max_rows**: 500件に制限（従来1000件→500件）
- **目的**: 大量データ取得による悪用防止
- **影響**: 正常なアプリケーション動作には影響なし

### 2. 認証セキュリティ強化

#### JWT設定
- **jwt_expiry**: 30分に短縮（従来60分→30分）
- **目的**: トークン漏洩リスクの軽減
- **影響**: ユーザーの再認証頻度がわずかに増加

#### パスワード要件強化
- **minimum_password_length**: 8文字以上必須
- **password_requirements**: 大文字・小文字・数字の組み合わせ必須
- **目的**: パスワード強度向上による不正アクセス防止

### 3. レート制限の厳格化

| 項目 | 従来 | 強化後 | 単位 |
|------|------|--------|------|
| email_sent | 2 | 1 | 件/時間 |
| sms_sent | 30 | 10 | 件/時間 |
| anonymous_users | 30 | 5 | 件/時間/IP |
| token_refresh | 150 | 50 | 件/5分/IP |
| sign_in_sign_ups | 30 | 10 | 件/5分/IP |
| token_verifications | 30 | 10 | 件/5分/IP |
| web3 | 30 | 10 | 件/5分/IP |

#### 設定理由
- **Botアクセス防止**: 自動化された攻撃の抑制
- **リソース保護**: サーバーリソースの適切な分配
- **ユーザー体験**: 正常利用に影響しない範囲で設定

### 4. CAPTCHA設定（本番環境推奨）

#### 設定概要
- **Provider**: hCaptcha推奨
- **用途**: 自動化された不正登録・ログイン防止
- **開発環境**: 無効（開発効率優先）
- **本番環境**: 有効化推奨

#### 実装方法
```toml
[auth.captcha]
enabled = true
provider = "hcaptcha"
secret = "env(CAPTCHA_SECRET)"
```

### 5. ネットワーク制限（本番環境必須）

#### IP制限設定
```toml
[db.network_restrictions]
enabled = true
allowed_cidrs = ["trusted.ip.range/24"]
allowed_cidrs_v6 = ["trusted:ipv6:range::/64"]
```

#### 実装ガイドライン
- **開発環境**: 制限なし（0.0.0.0/0）
- **本番環境**: 信頼できるIPレンジのみ許可
- **推奨**: VPN経由アクセスの強制

## 環境別セキュリティ設定

### 開発環境（config.local.toml）
- レート制限を緩和（開発効率優先）
- CAPTCHA無効
- ネットワーク制限無効
- JWT有効期限延長（60分）

### 本番環境（config.production.toml）
- 全セキュリティ機能有効
- 厳格なレート制限
- CAPTCHA有効
- ネットワーク制限有効
- JWT有効期限短縮（30分）

## セキュリティ監視とアラート

### 推奨監視項目
1. **認証失敗率**: 異常な認証失敗の検出
2. **レート制限到達**: Bot攻撃の兆候検出
3. **異常なデータアクセス**: 大量データ取得の監視
4. **IP地理分布**: 異常な地域からのアクセス

### アラート設定
- 短時間での大量認証失敗
- レート制限到達頻度の異常
- 未知のIPからの管理操作

## 実装チェックリスト

### 開発環境セットアップ
- [ ] config.local.tomlの確認
- [ ] 環境変数の設定
- [ ] セキュリティ設定の動作確認

### 本番環境デプロイ前
- [ ] config.production.tomlの確認
- [ ] CAPTCHA設定とテスト
- [ ] ネットワーク制限の設定
- [ ] 監視・アラート設定
- [ ] セキュリティテストの実行

### 定期確認項目
- [ ] セキュリティ設定の見直し（月次）
- [ ] レート制限の適切性確認
- [ ] セキュリティログの分析
- [ ] 脆弱性スキャンの実行

## トラブルシューティング

### よくある問題と解決策

#### ユーザーがログインできない
1. レート制限到達の確認
2. パスワード要件の確認
3. JWT有効期限の確認

#### アプリケーションが遅い
1. max_rows設定の確認
2. レート制限の調整検討
3. 接続プール設定の確認

#### 認証エラーが多発
1. JWT設定の確認
2. 時刻同期の確認
3. セキュリティ設定の見直し

## 緊急時対応

### セキュリティインシデント発生時
1. 該当IPのブロック
2. レート制限の一時強化
3. 認証トークンの無効化
4. セキュリティログの保全

### 設定ロールバック手順
1. 旧設定ファイルの復元
2. Supabaseサービスの再起動
3. 動作確認の実施
4. ユーザー通知（必要に応じて）

## 参考資料

- [Supabase Security Guide](https://supabase.com/docs/guides/platform/security)
- [Authentication Security Best Practices](https://supabase.com/docs/guides/auth/auth-security)
- [Rate Limiting Configuration](https://supabase.com/docs/guides/platform/rate-limits)