-- Add usage flags to tag_groups
alter table public.tag_groups
  add column if not exists use_for_training boolean not null default true,
  add column if not exists show_in_ui boolean not null default true;

-- Ensure names are unique for idempotent inserts
do $$
begin
  if not exists (
    select 1
    from information_schema.table_constraints
    where table_name = 'tag_groups'
      and constraint_name = 'tag_groups_name_key'
  ) then
    alter table public.tag_groups
      add constraint tag_groups_name_key unique (name);
  end if;
end$$;

-- Seed default tag groups with usage flags
insert into public.tag_groups (name, use_for_training, show_in_ui)
values
  ('シチュエーション', true, true),
  ('タイプ', true, true),
  ('コスチューム', true, true),
  ('ジャンル', true, true),
  ('プレイ', true, true),
  ('その他', true, false),
  ('セール', false, false),
  ('未分類', false, false)
on conflict (name) do update
set
  use_for_training = excluded.use_for_training,
  show_in_ui = excluded.show_in_ui;

-- Map tags to tag_groups using docs/dmm_genres.csv
with tag_mapping(tag_name, group_name) as (
  ('アイドル・芸能人','シチュエーション'),
  ('アクメ・オーガズム','シチュエーション'),
  ('アスリート','シチュエーション'),
  ('姉・妹','シチュエーション'),
  ('イタズラ','シチュエーション'),
  ('インストラクター','シチュエーション'),
  ('ウェイトレス','シチュエーション'),
  ('受付嬢','シチュエーション'),
  ('エステ','シチュエーション'),
  ('M男','シチュエーション'),
  ('M女','シチュエーション'),
  ('OL','シチュエーション'),
  ('お母さん','シチュエーション'),
  ('女将・女主人','シチュエーション'),
  ('幼なじみ','シチュエーション'),
  ('お爺ちゃん','シチュエーション'),
  ('お嬢様・令嬢','シチュエーション'),
  ('オタク','シチュエーション'),
  ('オナサポ','シチュエーション'),
  ('お姉さん','シチュエーション'),
  ('お婆ちゃん','シチュエーション'),
  ('叔母さん','シチュエーション'),
  ('お姫様','シチュエーション'),
  ('お風呂','シチュエーション'),
  ('温泉','シチュエーション'),
  ('女教師','シチュエーション'),
  ('女上司','シチュエーション'),
  ('女戦士','シチュエーション'),
  ('女捜査官','シチュエーション'),
  ('カーセックス','シチュエーション'),
  ('格闘家','シチュエーション'),
  ('カップル','シチュエーション'),
  ('家庭教師','シチュエーション'),
  ('看護婦・ナース','シチュエーション'),
  ('義母','シチュエーション'),
  ('逆ナン','シチュエーション'),
  ('キャバ嬢・風俗嬢','シチュエーション'),
  ('ギャル','シチュエーション'),
  ('キャンギャル','シチュエーション'),
  ('近親相姦','シチュエーション'),
  ('くノ一','シチュエーション'),
  ('極道・任侠','シチュエーション'),
  ('コンパニオン','シチュエーション'),
  ('時間停止','シチュエーション'),
  ('主観','シチュエーション'),
  ('熟女','シチュエーション'),
  ('女医','シチュエーション'),
  ('女王様','シチュエーション'),
  ('職業色々','シチュエーション'),
  ('女子アナ','シチュエーション'),
  ('女子校生','シチュエーション'),
  ('女子大生','シチュエーション'),
  ('ショタ','シチュエーション'),
  ('白目・失神','シチュエーション'),
  ('スチュワーデス','シチュエーション'),
  ('スワッピング・夫婦交換','シチュエーション'),
  ('性転換・女体化','シチュエーション'),
  ('セレブ','シチュエーション'),
  ('チアガール','シチュエーション'),
  ('痴女','シチュエーション'),
  ('ツンデレ','シチュエーション'),
  ('デート','シチュエーション'),
  ('盗撮・のぞき','シチュエーション'),
  ('ドール','シチュエーション'),
  ('寝取り・寝取られ・NTR','シチュエーション'),
  ('ノーパン','シチュエーション'),
  ('ノーブラ','シチュエーション'),
  ('飲み会・合コン','シチュエーション'),
  ('ハーレム','シチュエーション'),
  ('バスガイド','シチュエーション'),
  ('花嫁','シチュエーション'),
  ('秘書','シチュエーション'),
  ('ビッチ','シチュエーション'),
  ('人妻・主婦','シチュエーション'),
  ('病院・クリニック','シチュエーション'),
  ('ファン感謝・訪問','シチュエーション'),
  ('部活・マネージャー','シチュエーション'),
  ('部下・同僚','シチュエーション'),
  ('不倫','シチュエーション'),
  ('ヘルス・ソープ','シチュエーション'),
  ('変身ヒロイン','シチュエーション'),
  ('ホテル','シチュエーション'),
  ('マッサージ・リフレ','シチュエーション'),
  ('魔法少女','シチュエーション'),
  ('ママ友','シチュエーション'),
  ('未亡人','シチュエーション'),
  ('娘・養女','シチュエーション'),
  ('胸チラ','シチュエーション'),
  ('メイド','シチュエーション'),
  ('面接','シチュエーション'),
  ('モデル','シチュエーション'),
  ('野外・露出','シチュエーション'),
  ('ヨガ','シチュエーション'),
  ('乱交','シチュエーション'),
  ('旅行','シチュエーション'),
  ('レースクィーン','シチュエーション'),
  ('若妻・幼妻','シチュエーション'),
  ('アジア女優','タイプ'),
  ('巨尻','タイプ'),
  ('巨乳','タイプ'),
  ('筋肉','タイプ'),
  ('小柄','タイプ'),
  ('黒人男優','タイプ'),
  ('処女','タイプ'),
  ('女装・男の娘','タイプ'),
  ('スレンダー','タイプ'),
  ('早漏','タイプ'),
  ('そっくりさん','タイプ'),
  ('台湾モデル','タイプ'),
  ('長身','タイプ'),
  ('超乳','タイプ'),
  ('デカチン・巨根','タイプ'),
  ('デブ専','タイプ'),
  ('ドM','タイプ'),
  ('ドS','タイプ'),
  ('童顔','タイプ'),
  ('年下','タイプ'),
  ('年上','タイプ'),
  ('ニューハーフ','タイプ'),
  ('白人女優','タイプ'),
  ('ハーフ','タイプ'),
  ('爆乳','タイプ'),
  ('微乳','タイプ'),
  ('貧乳・微乳','タイプ'),
  ('ぽっちゃり','タイプ'),
  ('美乳','タイプ'),
  ('美尻','タイプ'),
  ('美脚','タイプ'),
  ('美黒','タイプ'),
  ('美少女','タイプ'),
  ('美白','タイプ'),
  ('美尻フェチ','タイプ'),
  ('美脚フェチ','タイプ'),
  ('プリ尻','タイプ'),
  ('マッチョ','タイプ'),
  ('モデル体型','タイプ'),
  ('痩せ型','タイプ'),
  ('若妻','タイプ'),
  ('和服・和装','コスチューム'),
  ('学生服','コスチューム'),
  ('競泳・スクール水着','コスチューム'),
  ('コスプレ','コスチューム'),
  ('制服','コスチューム'),
  ('セーラー服','コスチューム'),
  ('体操着・ブルマ','コスチューム'),
  ('チャイナドレス','コスチューム'),
  ('ドレス','コスチューム'),
  ('ナース服','コスチューム'),
  ('ニーハイ・ガーターベルト','コスチューム'),
  ('バニーガール','コスチューム'),
  ('バニー・マジシャン','コスチューム'),
  ('パジャマ・寝巻き','コスチューム'),
  ('ビキニ','コスチューム'),
  ('ビジネススーツ','コスチューム'),
  ('ピチピチスーツ','コスチューム'),
  ('フィットネス','コスチューム'),
  ('ボディコン/レオタード','コスチューム'),
  ('水着','コスチューム'),
  ('メイド服','コスチューム'),
  ('裸エプロン','コスチューム'),
  ('バンソウコウ','コスチューム'),
  ('ボンデージ','コスチューム'),
  ('マイクロビキニ','コスチューム'),
  ('レオタード','コスチューム'),
  ('ロリータ','コスチューム'),
  ('アクション・格闘','ジャンル'),
  ('脚フェチ','ジャンル'),
  ('アニメ','ジャンル'),
  ('イメージビデオ','ジャンル'),
  ('イメージビデオ（男性）','ジャンル'),
  ('イメージビデオ（女性）','ジャンル'),
  ('インタビュー','ジャンル'),
  ('エロス','ジャンル'),
  ('エロバラエティ','ジャンル'),
  ('エンタメ','ジャンル'),
  ('オムニバス','ジャンル'),
  ('カップル向け','ジャンル'),
  ('官能小説','ジャンル'),
  ('ギャンブル','ジャンル'),
  ('教育','ジャンル'),
  ('キッズ','ジャンル'),
  ('ギャグ','ジャンル'),
  ('クラシック','ジャンル'),
  ('ゲイ','ジャンル'),
  ('原作コラボ','ジャンル'),
  ('コラボ作品','ジャンル'),
  ('サイコ・スリラー','ジャンル'),
  ('残虐表現','ジャンル'),
  ('女性向け','ジャンル'),
  ('女優ベスト・総集編','ジャンル'),
  ('尻フェチ','ジャンル'),
  ('素人','ジャンル'),
  ('スポーツ','ジャンル'),
  ('セクシー','ジャンル'),
  ('その他フェチ','ジャンル'),
  ('ダーク系','ジャンル'),
  ('体験告白','ジャンル'),
  ('ダンス','ジャンル'),
  ('単体作品','ジャンル'),
  ('着エロ','ジャンル'),
  ('デビュー作品','ジャンル'),
  ('ドキュメンタリー','ジャンル'),
  ('特撮','ジャンル'),
  ('ドラマ','ジャンル'),
  ('ナンパ','ジャンル'),
  ('How To','ジャンル'),
  ('パンチラ','ジャンル'),
  ('ファンタジー','ジャンル'),
  ('Vシネマ','ジャンル'),
  ('復刻','ジャンル'),
  ('ベスト・総集編','ジャンル'),
  ('BL（ボーイズラブ）','ジャンル'),
  ('ホラー','ジャンル'),
  ('妄想','ジャンル'),
  ('洋ピン・海外輸入','ジャンル'),
  ('レズビアン','ジャンル'),
  ('恋愛','ジャンル'),
  ('足コキ','プレイ'),
  ('汗だく','プレイ'),
  ('アナル','プレイ'),
  ('アナルセックス','プレイ'),
  ('異物挿入','プレイ'),
  ('イラマチオ','プレイ'),
  ('淫語','プレイ'),
  ('飲尿','プレイ'),
  ('男の潮吹き','プレイ'),
  ('オナニー','プレイ'),
  ('おもちゃ','プレイ'),
  ('監禁','プレイ'),
  ('顔射','プレイ'),
  ('浣腸','プレイ'),
  ('顔面騎乗','プレイ'),
  ('騎乗位','プレイ'),
  ('キス・接吻','プレイ'),
  ('鬼畜','プレイ'),
  ('くすぐり','プレイ'),
  ('クスコ','プレイ'),
  ('クンニ','プレイ'),
  ('ゲロ','プレイ'),
  ('拘束','プレイ'),
  ('拷問','プレイ'),
  ('ごっくん','プレイ'),
  ('3P・4P','プレイ'),
  ('潮吹き','プレイ'),
  ('シックスナイン','プレイ'),
  ('縛り・緊縛','プレイ'),
  ('羞恥','プレイ'),
  ('触手','プレイ'),
  ('食糞','プレイ'),
  ('スカトロ','プレイ'),
  ('スパンキング','プレイ'),
  ('即ハメ','プレイ'),
  ('脱糞','プレイ'),
  ('ディルド','プレイ'),
  ('手コキ','プレイ'),
  ('電マ','プレイ'),
  ('ドラッグ','プレイ'),
  ('中出し','プレイ'),
  ('パイズリ','プレイ'),
  ('バイブ','プレイ'),
  ('辱め','プレイ'),
  ('バック','プレイ'),
  ('罵倒','プレイ'),
  ('鼻フック','プレイ'),
  ('ハメ撮り','プレイ'),
  ('孕ませ','プレイ'),
  ('フィスト','プレイ'),
  ('フェラ','プレイ'),
  ('ぶっかけ','プレイ'),
  ('放置','プレイ'),
  ('放尿・お漏らし','プレイ'),
  ('母乳','プレイ'),
  ('ポルチオ','プレイ'),
  ('指マン','プレイ'),
  ('ラブコメ','プレイ'),
  ('レズキス','プレイ'),
  ('蝋燭','プレイ'),
  ('ローション・オイル','プレイ'),
  ('ローター','プレイ'),
  ('インディーズ','その他'),
  ('AI生成作品','その他'),
  ('ギリモザ','その他'),
  ('ゲーム実写版','その他'),
  ('16時間以上作品','その他'),
  ('スマホ推奨縦動画','その他'),
  ('3D','その他'),
  ('セット商品','その他'),
  ('その他','その他'),
  ('デジモ','その他'),
  ('投稿','その他'),
  ('独占配信','その他'),
  ('ハイクオリティVR','その他'),
  ('ハイビジョン','その他'),
  ('8KVR','その他'),
  ('FANZA配信限定','その他'),
  ('VR専用','その他'),
  ('複数話','その他'),
  ('福袋','その他'),
  ('4時間以上作品','その他'),
  ('4K','その他'),
  ('すべてのセール','セール'),
  ('日替わりセール♭','セール'),
  ('SODグループ30％OFF','セール'),
  ('ABC/妄想族他30％OFF','セール'),
  ('グローリークエスト他30％OFF','セール'),
  ('エマニエル30％OFF','セール'),
  ('ブランドストア30％OFF！','セール'),
  ('エスワンキャンペーン30％OFF第5弾','セール'),
  ('熟女・人妻30％OFF第10弾','セール'),
  ('期間限定セール','セール')
),
resolved as (
  select
    tm.tag_name,
    coalesce(g.id, (select id from public.tag_groups where name = '未分類')) as tag_group_id
  from tag_mapping tm
  left join public.tag_groups g on g.name = tm.group_name
)
update public.tags t
set tag_group_id = r.tag_group_id
from resolved r
where t.name = r.tag_name;

update public.tags
set tag_group_id = (select id from public.tag_groups where name = '未分類')
where tag_group_id is null;
