# Backend Architecture Design Document
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## æ¦‚è¦

Adult Matching ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚æ©Ÿæ¢°å­¦ç¿’ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’çµ±ä¸€çš„ã«ç®¡ç†ã™ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚

## ğŸ—ï¸ æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
backend/
â”œâ”€â”€ __init__.py                          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆæœŸåŒ–
â”œâ”€â”€ README.md                            # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å…¨ä½“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”œâ”€â”€ ARCHITECTURE.md                      # æœ¬è¨­è¨ˆæ›¸
â”‚
â”œâ”€â”€ ml/                                  # ğŸ¤– æ©Ÿæ¢°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ scripts/                         # MLã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ training/                    # è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ train_768_dim_two_tower.py
â”‚   â”‚   â”‚   â”œâ”€â”€ train_production_two_tower.py
â”‚   â”‚   â”‚   â”œâ”€â”€ train_standard_model.py
â”‚   â”‚   â”‚   â”œâ”€â”€ train_two_tower_comprehensive.py
â”‚   â”‚   â”‚   â””â”€â”€ train_two_tower_model.py
â”‚   â”‚   â”œâ”€â”€ testing/                     # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ simple_two_tower_test.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_768_pgvector_integration.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_training_components.py
â”‚   â”‚   â”‚   â””â”€â”€ verify_768_model.py
â”‚   â”‚   â”œâ”€â”€ deployment/                  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”‚   â””â”€â”€ model_deployment.py
â”‚   â”‚   â””â”€â”€ standardize_models_768.py
â”‚   â”œâ”€â”€ training/                        # è¨“ç·´ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ trainers/
â”‚   â”‚   â”‚   â””â”€â”€ unified_two_tower_trainer.py
â”‚   â”‚   â””â”€â”€ configs/
â”‚   â”‚       â””â”€â”€ standard_768_config.json
â”‚   â”œâ”€â”€ preprocessing/                   # å‰å‡¦ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ features/                    # ç‰¹å¾´å‡¦ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ feature_processor.py
â”‚   â”‚   â”‚   â”œâ”€â”€ user_feature_processor.py
â”‚   â”‚   â”‚   â””â”€â”€ item_feature_processor.py
â”‚   â”‚   â”œâ”€â”€ embeddings/                  # åŸ‹ã‚è¾¼ã¿ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ embedding_manager.py
â”‚   â”‚   â””â”€â”€ utils/                       # å‰å‡¦ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚       â”œâ”€â”€ feature_scaler.py
â”‚   â”‚       â””â”€â”€ data_validator.py
â”‚   â”œâ”€â”€ deployment/                      # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ tensorflowjs_converter.py
â”‚   â””â”€â”€ utils/                           # MLãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ logger.py
â”‚       â”œâ”€â”€ config_loader.py
â”‚       â””â”€â”€ gpu_manager.py
â”‚
â”œâ”€â”€ data/                                # ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ __init__.py                      # çµ±åˆãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
â”‚   â”œâ”€â”€ ingestion/                       # ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ data_ingestion_manager.py
â”‚   â”œâ”€â”€ processing/                      # ãƒ‡ãƒ¼ã‚¿å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ unified_data_processor.py
â”‚   â”œâ”€â”€ validation/                      # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ data_validator.py
â”‚   â”œâ”€â”€ export/                          # ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ export_manager.py
â”‚   â”œâ”€â”€ schemas/                         # ã‚¹ã‚­ãƒ¼ãƒç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ schema_manager.py
â”‚   â”œâ”€â”€ pipelines/                       # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ pipeline_manager.py
â”‚   â”œâ”€â”€ utils/                           # ãƒ‡ãƒ¼ã‚¿ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â””â”€â”€ storage/                         # ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
â”‚       â”œâ”€â”€ raw/                         # ç”Ÿãƒ‡ãƒ¼ã‚¿
â”‚       â”œâ”€â”€ processed/                   # å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
â”‚       â”œâ”€â”€ validated/                   # æ¤œè¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
â”‚       â”œâ”€â”€ exports/                     # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
â”‚       â”œâ”€â”€ cache/                       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥
â”‚       â”œâ”€â”€ models/                      # ğŸ¯ è¨“ç·´æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ä¿å­˜
â”‚       â”‚   â”œâ”€â”€ two_tower_pattern1/      # Two-Towerãƒ¢ãƒ‡ãƒ«
â”‚       â”‚   â””â”€â”€ comprehensive_two_tower_pattern1/
â”‚       â”œâ”€â”€ logs/                        # ãƒ­ã‚°
â”‚       â”œâ”€â”€ schemas/                     # ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«
â”‚       â””â”€â”€ temp/                        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«
â”‚
â”œâ”€â”€ tests/                               # ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_framework.py                # çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
â”‚   â”œâ”€â”€ logs/                            # ãƒ†ã‚¹ãƒˆãƒ­ã‚°
â”‚   â””â”€â”€ test_report.json                 # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ
â”‚
â”œâ”€â”€ scripts/                             # âš™ï¸ ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”œâ”€â”€ unified_script_runner.py         # çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ script_migration_manager.py      # ã‚¹ã‚¯ãƒªãƒ—ãƒˆç§»è¡Œç®¡ç†
â”‚   â”œâ”€â”€ migration_report.json            # ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ deployment/                      # ğŸš€ ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ docker/                      # Dockerè¨­å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ Dockerfile.backend
â”‚   â”‚   â”‚   â””â”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ kubernetes/                  # Kubernetesè¨­å®š
â”‚   â”‚   â”‚   â””â”€â”€ backend-deployment.yaml
â”‚   â”‚   â”œâ”€â”€ monitoring/                  # ç›£è¦–è¨­å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ prometheus.yml
â”‚   â”‚   â”‚   â””â”€â”€ alert_rules.yml
â”‚   â”‚   â””â”€â”€ optimization/                # æœ€é©åŒ–è¨­å®š
â”‚   â”œâ”€â”€ organized/                       # æ•´ç†æ¸ˆã¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ ml-training/
â”‚   â”‚   â”œâ”€â”€ data-processing/
â”‚   â”‚   â”œâ”€â”€ api-sync/
â”‚   â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ deployment/
â”‚   â”‚   â”œâ”€â”€ maintenance/
â”‚   â”‚   â””â”€â”€ legacy/
â”‚   â”œâ”€â”€ batch-processing/
â”‚   â””â”€â”€ data-migration/
â”‚
â””â”€â”€ utils/                               # ğŸ”§ å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ logger.py                        # ãƒ­ã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    â”œâ”€â”€ config.py                        # è¨­å®šç®¡ç†
    â”œâ”€â”€ database.py                      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    â””â”€â”€ helpers.py                       # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
```

## ğŸ¯ ä¸»è¦ãªè¨­è¨ˆç‰¹å¾´

### 1. **çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**
- **å˜ä¸€è²¬ä»»ã®åŸå‰‡**: å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ˜ç¢ºãªè²¬ä»»ã‚’æŒã¤
- **éšå±¤åŒ–è¨­è¨ˆ**: æ©Ÿèƒ½åˆ¥ã®æ˜ç¢ºãªéšå±¤æ§‹é€ 
- **çµ±åˆç®¡ç†**: çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã®ç®¡ç†

### 2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
- **ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ**: ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®æ§‹é€ ä¿æŒ
- **å†åˆ©ç”¨æ€§**: å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ´»ç”¨

### 3. **é‹ç”¨æ€§**
- **çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ**: `unified_script_runner.py`
- **åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ**: è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **ç›£è¦–ãƒ»ãƒ­ã‚°**: æœ¬æ ¼çš„ãªé‹ç”¨ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
Raw Data â†’ Ingestion â†’ Processing â†’ Validation â†’ Storage
    â†“
ML Training â†’ Model Storage â†’ Deployment â†’ Inference
    â†“
Monitoring â† Logs â† Performance Metrics
```

## ğŸš€ çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ç”¨æ–¹æ³•

### 1. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ**
```bash
# å…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§
python backend/scripts/unified_script_runner.py list

# MLã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
python backend/scripts/unified_script_runner.py run train_768_two_tower

# DMMåŒæœŸå®Ÿè¡Œ
python backend/scripts/unified_script_runner.py run dmm_sync
```

### 2. **ãƒ‡ãƒ¼ã‚¿ç®¡ç†**
```python
from backend.data import create_data_manager

# çµ±åˆãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
managers = create_data_manager()
ingestion = managers["ingestion"]
processing = managers["processing"]
validation = managers["validation"]
```

### 3. **MLè¨“ç·´**
```python
from backend.ml.training.trainers.unified_two_tower_trainer import UnifiedTwoTowerTrainer

trainer = UnifiedTwoTowerTrainer()
model = trainer.train(config_path="backend/ml/training/configs/standard_768_config.json")
```

### 4. **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**
```bash
python backend/tests/test_framework.py
```

## ğŸ—‚ï¸ å‰Šé™¤æ¸ˆã¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

ä»¥ä¸‹ã®æ—§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯çµ±åˆã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼š

- âŒ `backend/data-processing/` â†’ `backend/data/` ã«çµ±åˆ
- âŒ `backend/edge_functions/` â†’ `supabase/functions/` ã«ç§»è¡Œ
- âŒ `backend/ml-pipeline/` â†’ `backend/ml/` ã«çµ±åˆ
- âŒ `backend/models/` â†’ `backend/data/storage/models/` ã«ç§»è¡Œ
- âŒ `backend/deployment/` â†’ `backend/scripts/deployment/` ã«ç§»è¡Œ

## ğŸ“‹ çµ±åˆã®åˆ©ç‚¹

### 1. **ä¸€è²«æ€§**
- çµ±ä¸€ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- æ¨™æº–åŒ–ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- å…±é€šã®è¨­å®šãƒ»ãƒ­ã‚°ç®¡ç†

### 2. **åŠ¹ç‡æ€§**
- é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®æ’é™¤
- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†åˆ©ç”¨
- çµ±åˆã•ã‚ŒãŸå®Ÿè¡Œç’°å¢ƒ

### 3. **ä¿å®ˆæ€§**
- æ˜ç¢ºãªè²¬ä»»åˆ†é›¢
- ç°¡å˜ãªæ©Ÿèƒ½è¿½åŠ ãƒ»å¤‰æ›´
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆãƒ»ç›£è¦–

## ğŸ”§ é–‹ç™ºãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 1. **æ–°æ©Ÿèƒ½è¿½åŠ **
- é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
- çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã«ç™»éŒ²
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¿½åŠ 

### 2. **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ**
- `backend/scripts/deployment/` ã®è¨­å®šã‚’ä½¿ç”¨
- æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã®ç¢ºèª

### 3. **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**
- `backend/data/` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½¿ç”¨
- ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ»æ¤œè¨¼ã®å®Ÿæ–½
- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†ã«ã‚ˆã‚‹è‡ªå‹•åŒ–

ã“ã®çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€Adult Matching ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã¯åŠ¹ç‡çš„ã§ä¿å®ˆæ€§ã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ ã¨ãªã‚Šã¾ã™ã€‚